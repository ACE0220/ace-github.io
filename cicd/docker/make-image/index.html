<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="构建自己的docker镜像"><meta name="keywords" content="web,microservice,node,docker,protobuffer,compose"><meta name="author" content="ACE0220"><meta name="copyright" content="ACE0220"><title>构建自己的docker镜像 | Ace's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%AC%E6%96%87%E9%9C%80%E6%B1%82"><span class="toc-number">1.</span> <span class="toc-text">本文需求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dockerfile"><span class="toc-number">2.</span> <span class="toc-text">Dockerfile</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Dockerfile%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.</span> <span class="toc-text">Dockerfile是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dockerfile%E9%83%A8%E5%88%86%E6%8C%87%E4%BB%A4%E7%AE%80%E4%BB%8B"><span class="toc-number">2.2.</span> <span class="toc-text">Dockerfile部分指令简介</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Edebian%E9%95%9C%E5%83%8F%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">基于debian镜像的安装与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Earm64v8-x2F-debian-stable-slim%E9%95%9C%E5%83%8F%E8%BF%90%E8%A1%8Ccontainer"><span class="toc-number">3.1.</span> <span class="toc-text">基于arm64v8&#x2F;debian:stable-slim镜像运行container</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#protoc-%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">protoc 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#npm%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8C%85%E5%AE%89%E8%A3%85ts-proto-tecace-x2F-ts-proto-batch"><span class="toc-number">3.3.</span> <span class="toc-text">npm相关的包安装ts-proto @tecace&#x2F;ts-proto-batch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#proto%E8%BD%AC%E6%8D%A2ts%E6%96%87%E4%BB%B6%E6%B5%8B%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">proto转换ts文件测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E4%BB%A5%E4%B8%8A%E6%B5%81%E7%A8%8B%E6%9E%84%E5%BB%BAdocker%E9%95%9C%E5%83%8F"><span class="toc-number">4.</span> <span class="toc-text">基于以上流程构建docker镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">4.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shell%E8%84%9A%E6%9C%AC"><span class="toc-number">4.2.</span> <span class="toc-text">shell脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dockerfile-1"><span class="toc-number">4.3.</span> <span class="toc-text">Dockerfile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">4.4.</span> <span class="toc-text">开始构建镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9E%84%E5%BB%BA%E5%A5%BD%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">4.5.</span> <span class="toc-text">启动构建好的镜像</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">ACE0220</div><div class="author-info__description text-center">Ace's blog, everything from the basics to the fun stuff</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">13</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">31</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">11</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Ace's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">构建自己的docker镜像</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-01</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/cicd/">cicd</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/cicd/docker/">docker</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>在现有cicd的流程中，一般是通过Dockerfile去将生产代码绑定到镜像中，由于docker的沙箱能安全的隔离环境，更加能保证代码运行环境的一致性。</p>
<p>如果没了解或者没用过docker的，建议先看<a target="_blank" rel="noopener" href="https://www.runoob.com/docker/docker-tutorial.html">一些入门教程</a>或者看<a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/">官方文档，点击打开</a>，因为本文不会很细致的讲一些安装、cli 命令之类的知识。主要还是提供一下构建镜像的流程，思路等。</p>
<span id="more"></span>

<h1 id="本文需求"><a href="#本文需求" class="headerlink" title="本文需求"></a>本文需求</h1><p>基于docker和grpc构建一个可以批量转换proto文件，生成typescript文件的一个镜像。</p>
<p>@tecace&#x2F;ts-proto-batch: <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@tecace/ts-proto-batch">https://www.npmjs.com/package/@tecace/ts-proto-batch</a><br>github: <a target="_blank" rel="noopener" href="https://github.com/ACE0220/ts-proto-batch">https://github.com/ACE0220/ts-proto-batch</a> dockerfile和shell脚本位于github内</p>
<h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><h2 id="Dockerfile是什么"><a href="#Dockerfile是什么" class="headerlink" title="Dockerfile是什么"></a>Dockerfile是什么</h2><p>Dockerfile 是用于构建镜像的配置文本文件，文本内容包含了一条条构建镜像所需的指令和说明。</p>
<h2 id="Dockerfile部分指令简介"><a href="#Dockerfile部分指令简介" class="headerlink" title="Dockerfile部分指令简介"></a>Dockerfile部分指令简介</h2><ul>
<li>FROM指令：用于指定我们的镜像基于哪个基础镜像，本文中的基础镜像是node（笔者的电脑是mac m1，所以用的基础镜像arm64v8&#x2F;node）</li>
<li>COPY指令: 从上下文目录中复制文件或目录到容器里指定路径。(上下文目录，即当前执行环境中相对或绝对目录，例如，在mac中执行构建镜像，那么上下文目录就是在mac中目录)<ul>
<li>COPY [–chown&#x3D;<user>:<group>] &lt;源路径1&gt;…  &lt;目标路径&gt;</li>
<li>[–chown&#x3D;<user>:<group>]：可选参数，用户改变复制到容器内文件的拥有者和属组</li>
</ul>
</li>
<li>RUN指令：用于执行后面跟着的命令行命令。有俩种格式<ul>
<li>RUN &lt;命令行命令&gt; eg. RUN “node -v” 等价于在终端输入 node -v</li>
<li>RUN [“可执行文件”, “参数1”, “参数2”] eg. RUN [‘node’, ‘-v’]</li>
</ul>
</li>
<li>CMD指令：与RUN指令类似，执行时机不同<ul>
<li>RUN 运行在docker build阶段（构建过程中执行）</li>
<li>CMD 运行在docker run阶段（开始运行容器执行）</li>
</ul>
</li>
<li>VOLUME指令：定义要挂在的数据卷，在docker run的时候可以通过-v指定容器的数据卷挂载在宿主机的哪个目录，如果没有特别指定，会挂载在匿名卷中，避免数据丢失</li>
</ul>
<h1 id="基于debian镜像的安装与测试"><a href="#基于debian镜像的安装与测试" class="headerlink" title="基于debian镜像的安装与测试"></a>基于debian镜像的安装与测试</h1><p>先进行手动搭建等价于前期调研测试等，测试通过则可以将手动的步骤写入Dockerfile，通过Dockerfile生成镜像。</p>
<p><strong>笔者环境是mac m1，docker desktop, arm64v8&#x2F;debian:stable-slim</strong></p>
<p><strong>笔者环境是mac m1，docker desktop, arm64v8&#x2F;debian:stable-slim</strong></p>
<p><strong>笔者环境是mac m1，docker desktop, arm64v8&#x2F;debian:stable-slim</strong></p>
<h2 id="基于arm64v8-x2F-debian-stable-slim镜像运行container"><a href="#基于arm64v8-x2F-debian-stable-slim镜像运行container" class="headerlink" title="基于arm64v8&#x2F;debian:stable-slim镜像运行container"></a>基于arm64v8&#x2F;debian:stable-slim镜像运行container</h2><p>运行容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -dit --name debian-test arm64v8/debian:stable-slim</span><br></pre></td></tr></table></figure>

<p>进入容器内部，并安装基础依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it debian-test bash</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install sudo vim wget curl unzip</span><br><span class="line">curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<h2 id="protoc-安装"><a href="#protoc-安装" class="headerlink" title="protoc 安装"></a>protoc 安装</h2><p>Protobuf即Protocol Buffers，是Google公司开发的一种跨语言和平台的序列化数据结构的方式，是一个灵活的、高效的用于序列化数据的协议。</p>
<p>而protoc则是官方提供的一种编译器，用于编译proto文件，可以编译成java、python、go等代码</p>
<p>下载protoc二进制包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/protocolbuffers/protobuf/releases/download/v23.1/protoc-23.1-linux-aarch_64.zip</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip protoc-23.1-linux-aarch_64.zip</span><br></pre></td></tr></table></figure>

<p>复制文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> bin/protoc /usr/local/bin/</span><br><span class="line"><span class="built_in">cp</span> -r include/google/ /usr/local/include/</span><br></pre></td></tr></table></figure>

<p>测试，终端输入protoc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Usage: protoc [OPTION] PROTO_FILES</span><br><span class="line">Parse PROTO_FILES and generate output based on the options given:</span><br><span class="line">  -IPATH, --proto_path=PATH   Specify the directory <span class="keyword">in</span> <span class="built_in">which</span> to search <span class="keyword">for</span></span><br><span class="line">                              imports.  May be specified multiple <span class="built_in">times</span>;</span><br><span class="line">                              directories will be searched <span class="keyword">in</span> order.  If not</span><br><span class="line">                              given, the current working directory is used.</span><br><span class="line">                              If not found <span class="keyword">in</span> any of the these directories,</span><br><span class="line">                              the --descriptor_set_in descriptors will be</span><br><span class="line">                              checked <span class="keyword">for</span> required proto file.</span><br><span class="line">  --version                   Show version info and <span class="built_in">exit</span>.</span><br><span class="line">  -h, --<span class="built_in">help</span>                  Show this text and <span class="built_in">exit</span>.</span><br><span class="line">  --encode=MESSAGE_TYPE       Read a text-format message of the given <span class="built_in">type</span></span><br><span class="line">                              from standard input and write it <span class="keyword">in</span> binary</span><br><span class="line">                              to standard output.  The message <span class="built_in">type</span> must</span><br><span class="line">                              be defined <span class="keyword">in</span> PROTO_FILES or their imports.</span><br></pre></td></tr></table></figure>

<h2 id="npm相关的包安装ts-proto-tecace-x2F-ts-proto-batch"><a href="#npm相关的包安装ts-proto-tecace-x2F-ts-proto-batch" class="headerlink" title="npm相关的包安装ts-proto @tecace&#x2F;ts-proto-batch"></a>npm相关的包安装ts-proto @tecace&#x2F;ts-proto-batch</h2><p>ts-proto是一个protoc的插件，经过插件处理后的数据可以生成ts文件，@tecace&#x2F;ts-proto-batch是笔者基于ts-proto开发的一个小模块。</p>
<p>功能主要是读取批量的protobuf文件，并按照输入的目录结构一一对应地生成相应的.ts文件。</p>
<p>@tecace&#x2F;ts-proto-batch地址：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@tecace/ts-proto-batch">https://www.npmjs.com/package/@tecace/ts-proto-batch</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g ts-proto @tecace/ts-proto-batch</span><br></pre></td></tr></table></figure>

<h2 id="proto转换ts文件测试"><a href="#proto转换ts文件测试" class="headerlink" title="proto转换ts文件测试"></a>proto转换ts文件测试</h2><p>创建测试用的文件和文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~ </span><br><span class="line"><span class="built_in">mkdir</span> tspb &amp;&amp; <span class="built_in">cd</span> tspb </span><br><span class="line"><span class="built_in">touch</span> top.proto </span><br><span class="line"><span class="built_in">mkdir</span> sub &amp;&amp; <span class="built_in">cd</span> sub </span><br><span class="line"><span class="built_in">touch</span> sub.proto</span><br></pre></td></tr></table></figure>

<p>top.proto 和 sub.proto填入一下内容</p>
<p>top.proto</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package demo;</span><br><span class="line"></span><br><span class="line">message Top &#123;</span><br><span class="line">    int64 client_id = 1;</span><br><span class="line">    string request_data = 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub.proto</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package demo;</span><br><span class="line"></span><br><span class="line">message Sub &#123;</span><br><span class="line">    int64 client_id = 1;</span><br><span class="line">    string request_data = 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换测试，执行一下命令后打开dist文件夹，里面会按照-i选项的目录结构生成对应的ts文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ts-pb gen -i . -o dist</span><br></pre></td></tr></table></figure>

<h1 id="基于以上流程构建docker镜像"><a href="#基于以上流程构建docker镜像" class="headerlink" title="基于以上流程构建docker镜像"></a>基于以上流程构建docker镜像</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>把前文中所有在debian镜像中的搭建流程融入shell脚本文件和Dockerfile。</p>
<p>前置的准备要不少，例如安装好node环境，protoc编译器，安装需要的npm包等，前置工作就可以放在shell脚本中。</p>
<p>那么Dockerfile可以做什么呢？</p>
<p>Dockerfile的主要作用是在脚本运行之前做一些准备工作，脚本中的环境配置结束之后，运行命令。</p>
<h2 id="shell脚本"><a href="#shell脚本" class="headerlink" title="shell脚本"></a>shell脚本</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/env sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"><span class="built_in">mkdir</span> data &amp;&amp; <span class="built_in">cd</span> data</span><br><span class="line">apt update</span><br><span class="line"><span class="built_in">echo</span> y | apt install sudo vim wget curl unzip</span><br><span class="line">curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br><span class="line"></span><br><span class="line">wget https://github.com/protocolbuffers/protobuf/releases/download/v23.1/protoc-23.1-linux-aarch_64.zip</span><br><span class="line">unzip protoc-23.1-linux-aarch_64.zip</span><br><span class="line"><span class="built_in">cp</span> bin/protoc /usr/local/bin/</span><br><span class="line"><span class="built_in">cp</span> -r include/google/ /usr/local/include/</span><br><span class="line">npm install -g ts-proto @tecace/ts-proto-batch</span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile-1"><a href="#Dockerfile-1" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM arm64v8/debian:stable-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 环境准备工作，通过创建文件夹，给文件和文件夹赋予权限，然后运行脚本等。</span></span><br><span class="line">RUN <span class="built_in">mkdir</span> /home/env &amp;&amp; <span class="built_in">chmod</span> -R 777 /home/env</span><br><span class="line">COPY docker-build.sh /home/env</span><br><span class="line">RUN <span class="built_in">chmod</span> -R 777 /home/env/docker-build.sh &amp;&amp; /home/env/docker-build.sh</span><br><span class="line">RUN <span class="built_in">mkdir</span> /home/data</span><br><span class="line">WORKDIR /home/data</span><br><span class="line">VOLUME [ <span class="string">&quot;/home/data&quot;</span> ]</span><br><span class="line"><span class="comment"># 在环境准备好之后，运行proto转换程序</span></span><br><span class="line">CMD ts-pb gen -i protos -o dist</span><br></pre></td></tr></table></figure>

<h2 id="开始构建镜像"><a href="#开始构建镜像" class="headerlink" title="开始构建镜像"></a>开始构建镜像</h2><p>Dockerfile和docker-build.sh位于同一个文件夹下，运行以下命令</p>
<p><strong>注意，命令最后还有一个.   这个符号代表docker build的时候的base path，在docker file中，copy文件的路径是基于命令最后的base path</strong></p>
<p>例如： </p>
<p>base path 是 . , dockerfile中的 COPY docker-build.sh &#x2F;home&#x2F;env，docker-build.sh会被处理成 “.&#x2F;docker-build.sh”,</p>
<p>如果是base path是 ..&#x2F;docker-shell，docker-build.sh会被处理成 “..&#x2F;docker-shell&#x2F;docker-build.sh”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t arm64v8/ts-proto-batch:v0.0.1 .</span><br></pre></td></tr></table></figure>

<h2 id="启动构建好的镜像"><a href="#启动构建好的镜像" class="headerlink" title="启动构建好的镜像"></a>启动构建好的镜像</h2><p>在镜像中固定为挂载路径下的protos存放proto 文件，生成的dist文件夹在protos文件夹同级</p>
<p>所以 -v 参数一定要提供，不提供无法识别到proto文件在哪个文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -dit --name tspb -v /Users/ace/volumes/tspb:/home/data arm64v8/ts-proto-batch:v0.0.1</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x2F;Users&#x2F;ace&#x2F;volumes&#x2F;tspb 这个路径一定要通过 -v 参数提供，由用户进行自定义<ul>
<li>&#x2F;Users&#x2F;ace&#x2F;volumes&#x2F;tspb&#x2F;protos 这里放置proto文件，支持多级文件夹</li>
<li>&#x2F;Users&#x2F;ace&#x2F;volumes&#x2F;tspb&#x2F;dist 运行结束会自动生成，dist文件夹内部结构与protos一致</li>
</ul>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ACE0220</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://ace0220.github.io/cicd/docker/make-image/">https://ace0220.github.io/cicd/docker/make-image/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a><a class="post-meta__tags" href="/tags/microservice/">microservice</a><a class="post-meta__tags" href="/tags/node/">node</a><a class="post-meta__tags" href="/tags/docker/">docker</a><a class="post-meta__tags" href="/tags/protobuffer/">protobuffer</a><a class="post-meta__tags" href="/tags/compose/">compose</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/microservice/node-ms-containerization/"><i class="fa fa-chevron-left">  </i><span>node 微服务简介与容器化入门</span></a></div><div class="next-post pull-right"><a href="/architecture/architecture-principle/"><span>架构设计的三原则和应用</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2023 By ACE0220</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010402003044" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="/pics/beian/beian.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">粤公网安备 44010402003044号</p></a></div><div class="icp"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn"><span>粤ICP备2023054092号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="100" alpha="0.4" zIndex="-99" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>